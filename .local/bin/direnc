#!/usr/bin/env bash

set -euo pipefail

source "$BASH_LIB_DIR/core.sh"
source "$BASH_LIB_DIR/path.sh"

help() {
  cat <<-EOT
		Mount directory using encfs.

		Usage:
		  $(self) [options] [--] <command>

		Options:
		  -e <dir>  Path to encrypted directory.
		  -d <dir>  Path to decrypted directory.
		  -h        Print this help.

		Commands:
		  s, status   Print directories and mount status.
		  m, mount    Mount private directory. Directories are created
		              and encryption is configured if they do not exist.
		  u, unmount  Unmout private directory.

		Environment variables:
		  ENCRYPTED_DIR  Default path to encrypted directory.
		  DECRYPTED_DIR  Default path to decrypted directory.
	EOT
}

main() {
  local enc_dir
  local dec_dir
  local opt

  enc_dir=$(path_from_env ENCRYPTED_DIR)
  dec_dir=$(path_from_env DECRYPTED_DIR)

  while getopts ":e:d:h" opt; do
    case "$opt" in
      e) enc_dir=$(path_make_absolute "$OPTARG") ;;
      d) dec_dir=$(path_make_absolute "$OPTARG") ;;
      h) help; exit ;;
      *) die_invalid_opt "$opt" ;;
    esac
  done

  shift $((OPTIND - 1))
  [[ $# -eq 0 ]] && die_missing_arg

  case "$1" in
    s|status) status ;;
    m|mount) mount ;;
    u|umount|unmount) unmount ;;
    *) die_help "invalid command '$1'" ;;
  esac
}

status() {
  if [[ $enc_dir ]]; then
    echo "Encrypted directory"
    echo "  path:   $enc_dir"
    echo -n "  status: "

    if [ -d "$enc_dir" ]; then
      echo "exists"
    elif [ -e "$enc_dir" ]; then
      echo "not a directory"
    else
      echo "not exists"
    fi
  else
    echo "No encrypted directory specified"
  fi

  if [[ $enc_dir || $dec_dir ]]; then
    echo
  fi

  if [[ $dec_dir ]]; then
    echo "Decrypted directory"
    echo "  path:  $dec_dir"
    echo -n "  status: "

    if [ -d "$dec_dir" ]; then
      if is_mounted; then
        echo "mounted"
      else
        echo "unmounted"
      fi
    elif [ -e "$dec_dir" ]; then
      echo "not a directory"
    else
      echo "not exists"
    fi
  else
    echo "No decrypted directory specified"
  fi
}

mount() {
  [[ $enc_dir ]] || die_help "no encrypted directory specified"
  [[ $dec_dir ]] || die_help "no decrypted directory specified"
  is_mounted && die "'$dec_dir' is already mounted"

  mkdir --parent "$enc_dir" "$dec_dir"
  encfs "$enc_dir" "$dec_dir"
  echo "Mounted '$enc_dir' as '$dec_dir'"
}

unmount() {
  [[ $dec_dir ]] || die_help "no decrypted directory specified"
  is_mounted || die "'$dec_dir' is not mounted"

  fusermount -u --unmount "$dec_dir"
  echo "Unmounted '$dec_dir'"
}

is_mounted() {
  mountpoint --quiet "$dec_dir"
}

main "$@"
