#!/usr/bin/env bash

set -euo pipefail

source "$BASH_LIB_DIR/core.sh"

help() {
  cat <<-EOT
		Print property of a Maven project in Git branches.

		Usage:
		  $(self) [<options>] <property> [<branch>...]

		Args:
		  <property>   Name of a property.
		  <branch>...  Git branches (all remote branches by default).

		Options:
		  -h  Print this help.

		The property is read from pom.xml in the current working directory.
	EOT
}

main() {
  local opt

  while getopts ":h" opt; do
    case "$opt" in
      h) help; exit ;;
      *) die_invalid_opt "$opt" ;;
    esac
  done

  shift $((OPTIND - 1))
  [[ $# -eq 0 ]] && die_missing_arg

  local property=$1
  shift 1

  local branch
  local branches

  if [[ $# -gt 0 ]]; then
    branches=("$@")
  else
    mapfile -t branches < <(git ls-branches -r)
  fi

  for branch in "${branches[@]}"; do
    print_row "$branch" "$property"
  done | format_table
}

print_row() {
  local value
  value=$(print_value "$1" "$2") || value="?"
  printf "%s;%s\n" "$value" "$1"
}

print_value() {
  git grep --fixed-strings "<$2>" "$1" -- pom.xml \
    | sed --regexp-extended 's/.*>(.*)<\/.*/\1/'
}

format_table() {
  column  --table --separator ";" | sort --version-sort
}

main "$@"
