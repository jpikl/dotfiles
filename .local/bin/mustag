#!/usr/bin/env bash

set -euo pipefail

source ~/.local/lib/bash/core.sh
source ~/.local/lib/bash/path.sh

help() {
  cat <<-EOT
		Auto fill ID3 tags in music directory.

		Usage:
		  $(self) [<options>] [<directory>]

		Args:
		  <directory> Music directory to process.
		              Defaults to the USER_MUSIC_DIR environment variable.

		Options:
		  -f  Force tag recreation.
		  -h  Print this help.
	EOT
}

main() {
  local force=false
  local opt

  while getopts ":fh" opt; do
    case "$opt" in
      f) force=true ;;
      h) help; exit ;;
      *) die_invalid_opt "$opt" ;;
    esac
  done

  shift $((OPTIND - 1))
  local music_dir

  if [[ $# -gt 0 ]]; then
    music_dir=$(path_make_absolute "$1")
  else
    music_dir=$(path_from_env USER_MUSIC_DIR)
  fi

  if [[ ! -d $music_dir ]]; then
    die "'$music_dir' is not a directory"
  fi

  if muscheck "$music_dir"; then
    if [[ $force == true ]]; then
      confirm "Force tag recreation for '$music_dir'?" || exit
    fi
    list_tracks | process_tracks
  else
    die "'$music_dir' has invalid structure"
  fi
}

list_tracks() {
  find "$music_dir" -mindepth 4 -maxdepth 4 | sort
}

process_tracks() {
  while IFS= read -r path; do
    if ! is_audio_file "$path"; then
      continue
    fi

    local number_title_ext=${path##*/}
    local number_title=${number_title_ext%.*}
    local title=${number_title#* - }
    local number=${number_title%% - *}

    local parent_path=${path%/*}
    local year_album=${parent_path##*/}
    local year=${year_album:0:4}
    local album=${year_album:7}

    local grand_parent_path=${parent_path%/*}
    local artist=${grand_parent_path##*/}

    if [[ $force == true ]]; then
      id3 -d \
          -a "$artist" \
          -y "$year" \
          -l "$album" \
          -n "$number" \
          -t "$title" \
          "$path"
    else
      echo
      echo "$path"
      echo "  artist: $artist"
      echo "  album: $album"
      echo "  year: $year"
      echo "  title: $title"
      echo "  number: $number"
    fi
  done
}

is_audio_file() {
  [[ $1 == *.mp3 || $1 == *.ogg || $1 == *.m4a ]]
}


main "$@"
