#!/usr/bin/env bash

set -euo pipefail

source ~/.local/lib/bash/core.sh

help() {
  cat <<-EOT
		Generate SSH key with user-friendly CLI wizard.

		Usage:
		  $(self) [<options>] [<hostname>]

		Args:
		  <hostname>  Remote hostname the SSH key will be used for.

		Options:
		  -h  Print this help.
	EOT
}

main() {
  local opt

  while getopts ":h" opt; do
    case "$opt" in
      h) help; exit ;;
      *) die_invalid_opt "$opt" ;;
    esac
  done

  local key_type
  key_type=$(choose -bp "Key type:" ed25519 rsa)
  [[ $key_type ]] || die

  local remote_hostname=${1-}
  read -rep "Remote hostname: " -i "$remote_hostname" remote_hostname

  local key_name="id"
  [[ $remote_hostname ]] && key_name+="_$remote_hostname"

  local key_file="$HOME/.ssh/$key_name"
  local pub_file="$HOME/.ssh/$key_name.pub"

  if [[ -e $key_file || -e $pub_file ]] && ! confirm "Overwrite existing $key_name.{key,pub}?"; then
    return
  fi

  local passphrase
  local passphrase_again
  local passphrase_set=

  while [[ -z $passphrase_set ]]; do
    read -rsep "Passphrase: " passphrase
    echo

    if [[ $passphrase ]]; then
      read -rsep "Passphrase (again): " passphrase_again
      echo

      if [[ $passphrase == "$passphrase_again" ]]; then
        passphrase_set=yes
      else
        echo "Passphrases do not match."
      fi
    else
      passphrase_set=no
    fi
  done

  local comment
  comment="$(whoami)@$(hostname)"
  read -rep "Comment: " -i "$comment" comment

  echo
  echo "[Summary]"
  echo "Key type:    $key_type"
  echo "Passphrase:  $passphrase_set"
  echo "Private key: $key_file"
  echo "Public key:  $pub_file"
  echo "Comment:     $comment"
  echo

  confirm "Generate key files?" || return 0

  local opts=(
    "-q"
    "-t" "$key_type"
    "-f" "$key_file"
    "-N" "$passphrase" # Must be passed even when it is empty, otherwise it would be requested
  )

  [[ $key_type = rsa ]] && opts+=("-b" 4096)
  [[ $comment ]] && opts+=("-C" "$comment")

  rm -f "$key_file" "$pub_file"
  ssh-keygen "${opts[@]}"
}

main "$@"
