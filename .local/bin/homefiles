#!/usr/bin/env bash

set -euo pipefail

source "$BASH_LIB_DIR/core.sh"
source "$BASH_LIB_DIR/input.sh"
source "$BASH_LIB_DIR/args.sh"

help() {
  cat <<-EOT
		Initialize home directory structure.

		Usage:
		  $(self) [options]

		Options:
		  -d  Create directories for *_DIR environment variables.
		  -s  Create symbolic links for *_LINK environment variables.
		  -c  Create default .profile_local and .bashrc_local files.
		  -f  Download patched fonts for terminal.
		  -h  Display this help.
	EOT
}

init() {
  local opt

  while getopts ":dscfh" opt; do
    case "$opt" in
      d) directories=true ;;
      s) symbolic_links=true ;;
      c) local_config=true ;;
      f) fonts=true ;;
      h) help; exit ;;
      *) die_invalid_opt "$opt" ;;
    esac
  done
}

create_dir() {
  if [[ ! -d $1 ]]; then
    echo "Creating directory '$1'"
    mkdir "$1"
  fi
}

create_dirs() {
  create_dir "$BACKUP_DIR"
  create_dir "$BINARIES_DIR"
  create_dir "$CACHE_DIR"
  create_dir "$CONFIG_DIR"
  create_dir "$DATA_DIR"
  create_dir "$DATA_DIR/mpd" # Has to exist otherwise mpd would not start.
  create_dir "$DESKTOP_DIR"
  create_dir "$DOCUMENTS_DIR"
  create_dir "$DOWNLOAD_DIR"
  create_dir "$LIBRARIES_DIR"
  create_dir "$MUSIC_DIR"
  create_dir "$PICTURES_DIR"
  create_dir "$PLAYLISTS_DIR"
  create_dir "$PRIVATE_DIR"
  create_dir "$PRIVATE_HIDDEN_DIR"
  create_dir "$PUBLIC_DIR"
  create_dir "$TEMP_DIR"
  create_dir "$VIDEOS_DIR"
  create_dir "$WORKSPACE_DIR"
}

create_sym_link() {
  if [[ ! -L $1 ]]; then
    echo "Creating symbolic link '$1' to '$2'"
    ln --symbolic --no-target-directory "$2" "$1"
  fi
}

create_sym_links() {
  create_sym_link "$BINARIES_LINK" "$BINARIES_DIR"
  create_sym_link "$CACHE_LINK" "$CACHE_DIR"
  create_sym_link "$CONFIG_LINK" "$CONFIG_DIR"
  create_sym_link "$DATA_LINK" "$DATA_DIR"
  create_sym_link "$LIBRARIES_LINK" "$LIBRARIES_DIR"
  create_sym_link "$MEDIA_LINK" "$MEDIA_DIR"
  create_sym_link "$VOLUMES_LINK" "$VOLUMES_DIR"
}

profile_export() {
  grep --extended-regexp --only-matching "$1" ~/.profile \
    | grep --extended-regexp --invert-match "${2:-#}" \
    | sort \
    | uniq \
    | xargs printf "#export %s=\n"
}

create_profile_local() {
  local -r file=~/.profile_local

  if [[ ! -f $file ]] || confirm "Overwrite existing $file?"; then
    {
      printf "# Generated by %s script.\n" "$(self)"
      printf "\n# Home directories\n"
      profile_export "[A-Z_]+_DIR" "MEDIA|VOLUME|_LIB_"
      printf "\n# Library directories\n"
      profile_export "[A-Z_]+_LIB_DIR"
      printf "\n# Links to directories\n"
      profile_export "[A-Z_]+_LINK"
    } >$file
  fi
}

create_bashrc_local() {
  local -r file=~/.bashrc_local

  if [[ ! -f $file ]] || confirm "Overwrite existing $file?"; then
    printf "# Generated by %s script.\n" "$(self)" >$file
  fi
}

download_font() {
  local -r font=$(basename "$1")
  local -r dir=$DATA_DIR/fonts
  local -r file=$dir/$font

  if [[ ! -f "$file" ]]; then
    echo "Downloading font '$font'"
    mkdir -p "$dir"
    wget --output-document="$file" "$1" || rm -f "$file" # Clean up unfinished download.
  fi
}

download_fonts() {
  for file in "Literation Mono Nerd Font Complete"{," Mono"}{," Windows Compatible"}.ttf; do
    download_font "https://github.com/ryanoasis/nerd-fonts/raw/master/patched-fonts/LiberationMono/complete/$file"
  done
}

run() {
  [[ $directories = true ]] && create_dirs
  [[ $symbolic_links = true ]] && create_sym_links
  [[ $local_config = true ]] && create_profile_local
  [[ $local_config = true ]] && create_bashrc_local
  [[ $fonts = true ]] && download_fonts
  true # To reset exit code
}

function main() {
  local directories=false
  local symbolic_links=false
  local local_config=false
  local fonts=false

  init "$@"
  run
}

main "$@"
