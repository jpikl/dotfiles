#!/usr/bin/env bash

set -euo pipefail

source "$BASH_LIB_DIR/core.sh"
source "$BASH_LIB_DIR/args.sh"
source "$BASH_LIB_DIR/utils.sh"

help() {
  cat <<-EOT
		Print progress bar.

		Usage:
		  $(self) [options] <value>

		Options:
		  -w, --width=<value>        Progress bar width (default: $width).
		  -m, --max-value=<value>    Maximum progress value (default: $max_value).
		  -f, --fg-char=<character>  Character used to draw foreground (default: '$fg_char').
		  -b, --bg-char=<character>  Character used to draw Background (default: '$bg_char').
		  -h, --help                 Display this help.

		Value:
		  Progress value between 0 and maximum value (default: $max_value).
	EOT
}

set_value() {
  # shellcheck disable=SC2015
  is_integer "$1" && [[ $1 -ge 0 ]] || die "Invalid value '$1'"
  value=$1
}

set_max_value() {
  # shellcheck disable=SC2015
  is_integer "$1" && [[ $1 -ge 1 ]] || die "invalid max value '$1'"
  max_value=$1
}

set_width() {
  # shellcheck disable=SC2015
  is_integer "$1" && [[ $1 -ge 1 ]] || die "invalid width '$1'"
  width=$1
}

set_fg_char() {
  # shellcheck disable=SC2015
  is_character "$1" || die "invalid foreground character '$1'"
  fg_char=$1
}

set_bg_char() {
  is_character "$1" || die "invalid background character '$1'"
  bg_char=$1
}

init() {
  local -r short_opts=w:m:f:b:h
  local -r long_opts=width:,max-value:,fg-char:,bg-char:,help
  local args

  args=$(get_args "$short_opts" "$long_opts" "$@")
  eval set -- "$args"

  while true ; do
    case "$1" in
      -w|--width)     set_width "$2"; shift 2 ;;
      -m|--max-value) set_max_value "$2"; shift 2 ;;
      -f|--fg-char)   set_fg_char "$2"; shift 2 ;;
      -b|--bg-char)   set_bg_char "$2"; shift 2 ;;
      -h|--help)      help; exit ;;
      --)             shift; break ;;
      *)              die_unprocessable_args ;;
    esac
  done

  if [[ $# -ge 1 ]]; then
    set_value "$1"
  else
    die_missing_args
  fi
}

progress_bar() {
  local -r fg_width=$(( width * value / max_value ))
  local -r bg_width=$(( width - fg_width ))

  repeat_value "$fg_width" "$fg_char"
  repeat_value "$bg_width" "$bg_char"
}

function main() {
  local value
  local max_value=100
  local width=80
  local fg_char="#"
  local bg_char="-"

  init "$@"
  progress_bar
}

main "$@"
