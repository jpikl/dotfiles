#!/usr/bin/env bash

# shellcheck source=.local/lib/bash/utils.sh
source "$BASH_LIB_DIR/utils.sh"

print_help() {
  echo "Search upwards in directory tree."
  echo
  echo "Usage:"
  echo "  $(self) [path] [expression]"
  echo
  echo "Path:"
  echo "  Search starting point."
  echo "  Default path is the current working directory."
  echo
  echo "Expression:"
  echo "  Any expression accepted by the find command."
  echo "  See 'find -help' or 'man find' for more details."
  echo "  Use of -maxdepth is discouraged since it's set internally to 1 by default."
}

process_args() {
  for arg in "$@"; do
    if [[ $arg == '-h' || $arg == '-help' || $arg == '--help' ]]; then
      print_help
      exit
    fi
  done

  if [[ $# -gt 0 && $1 != -* ]]; then
    path=$1
    shift
  fi

  expression+=("$@")
}

find_upwards() {
  [[ -d $path ]] || die "'$path' is not a directory!"
  cd "$path" || die_unable_cd

  while true; do
    find "$PWD" "${expression[@]}" || die
    if [[ $PWD == / ]]; then
      break;
    else
      cd .. || die_unable_cd
    fi
  done
}

function main() {
  local path=$PWD
  local expression=("-maxdepth" "1")

  process_args "$@"
  find_upwards
}

main "$@"
