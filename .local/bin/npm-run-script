#!/usr/bin/env bash

set -euo pipefail

source "$BASH_LIB_DIR/core.sh"
source "$BASH_LIB_DIR/args.sh"
source "$BASH_LIB_DIR/utils.sh"

help() {
  cat <<-EOT
		Run script of a npm package.

		Usage:
		  $(self) [options] [--] <script>...

		Options:
		  -r, --rerun-on-failure       Rerun script if it ends unexpectedly.
		  -d, --rerun-delay=<seconds>  Rerun delay (default: $rerun_delay).
		  -h, --help                   Display this help.

		Script:
		  One or more script names.
		  First of these scripts that is defined in package.json will be run.
	EOT
}

set_rerun_delay() {
  # shellcheck disable=SC2015
  is_integer "$1" && [[ $1 -ge 0 ]] || die "invalid rerun delay '$1'"
  rerun_delay=$1
}

init() {
  local -r short_opts=rd:h
  local -r long_opts=rerun-on-failure,rerun-delay:,help
  local args

  args=$(get_args "$short_opts" "$long_opts" "$@")
  eval set -- "$args"

  while true ; do
    case "$1" in
      -r|--rerun-on-failure) rerun_on_failure=true; shift ;;
      -d|--rerun-delay)      set_rerun_delay "$2"; shift 2 ;;
      -h|--help)             help; exit ;;
      --)                    shift; break ;;
      *)                     die_unprocessable_args ;;
    esac
  done

  if [[ $# -ge 1 ]]; then
    scripts=("$@")
  else
    die_missing_args
  fi
}

npm_run_any() {
  [[ -f package.json ]] || die "no package.json in the current directory"

  local available_scripts
  local target_script

  mapfile -t available_scripts < <(npm-list-scripts)

  for script in "${scripts[@]}"; do
    if is_one_of "$script" "${available_scripts[@]}"; then
      target_script=$script
      break;
    fi
  done

  if [[ -z $target_script ]]; then
    die "package.json has none of [$(join_values ", " "${scripts[@]}")] scripts"
  fi

  while ! npm run "$target_script"; do
    [[ $rerun_on_failure = true ]] || break
    printf "\npackage.json %s script unexpectedly crashed!\n" "$target_script" >&2
    interactive-sleep "$rerun_delay" "Script will automatically rerun" || true
  done
}

function main() {
  local rerun_on_failure
  local rerun_delay=30
  local scripts

  init "$@"
  npm_run_any
}

main "$@"
