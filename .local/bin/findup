#!/usr/bin/env bash

set -euo pipefail

source "$BASH_LIB_DIR/core.sh"
source "$BASH_LIB_DIR/args.sh"

help() {
  cat <<-EOT
		Search upwards in directory tree.

		Usage:
		  $(self) [path] [expression]

		Path:
		  Search starting point.
		  Default path is the current working directory.

		Expression:
		  Any expression accepted by the find command.
		  See 'find -help' or 'man find' for more details.
		  Use of -maxdepth is discouraged, it is set internally to 1 by default.
	EOT
}

set_path() {
  [[ -d $1 ]] || die "'$1' is not a directory"
  path=$1
}

init() {
  for arg in "$@"; do
    if [[ $arg == '-h' || $arg == '-help' || $arg == '--help' ]]; then
      help
      exit
    fi
  done

  if [[ $# -gt 0 && $1 != -* ]]; then
    set_path "$1"
    shift
  fi

  expression+=("$@")
}

run() {
  cd "$path"

  while true; do
    find "$PWD" "${expression[@]}"
    if [[ $PWD == / ]]; then
      break;
    else
      cd ..
    fi
  done
}

function main() {
  local path=$PWD
  local expression=("-maxdepth" "1")

  init "$@"
  run
}

main "$@"
