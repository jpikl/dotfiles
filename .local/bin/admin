#!/usr/bin/env sh

install_packages() {
    pm install <~/.config/pkgs/base
}

install_nodejs() {
    FNM_INSTALL_DIR=$HOME/.local/share/fnm

    # Always update to the latest fnm version
    curl -fsSL https://fnm.vercel.app/install | bash -s -- --install-dir "$FNM_INSTALL_DIR" --skip-shell
    export PATH="$PATH:$FNM_INSTALL_DIR"

    eval "$(fnm env)"
    fnm install --lts
    fnm default lts-latest
    fnm use lts-latest
    corepack enable

    if [ -f ~/.config/pkgs/npm ]; then
        xargs -r npm -g install <~/.config/pkgs/npm
    fi
}

install_rust() {
    if [ ! -x "$(command -v rustup)" ]; then
        curl --proto '=https' --tlsv1.2 -sSf https://sh.rustup.rs | sh -s -- -y --no-modify-path
    fi

    rustup self update
    rustup install stable
    rustup install nightly

    if [ -f ~/.config/pkgs/cargo ]; then
        xargs -r cargo install <~/.config/pkgs/cargo
    fi
}

generate_ssh_key() {
    echo "TODO"
}

switch_dotfiles_to_ssh() {
    dotenv git remote set-url origin git@github.com:jpikl/dotfiles.git
    dotenv git submodule set-url .local/share/pm git@github.com:jpikl/pm.git
}

list_actions() {
    echo "1) Install packages"
    echo "2) Install Node.js toolchain (or update it)"
    echo "3) Install Rust toolchain (or update it)"
    echo "4) Generate SSH key"
    echo "5) Switch dotfiles to SSH"
}

get_action() {
    case "$1" in
        1) echo install_packages ;;
        2) echo install_nodejs ;;
        3) echo install_rust ;;
        4) echo generate_ssh_key ;;
        5) echo switch_dotfiles_to_ssh ;;
    esac
}

while true; do
    list_actions
    echo "q) Quit"
    echo
    
    while true; do
        printf "Choose action: "
        read -r ANSWER

        if [ "$ANSWER" = q ] || [ "$ANSWER" = Q ]; then
            exit
        fi
        
        ACTION=$(get_action "$ANSWER")

        if [ "$ACTION" ]; then
            echo 
            echo "====================[ $ACTION :: start ]===================="
            echo 
            "$ACTION"
            echo 
            echo "====================[ $ACTION :: end ]===================="
            echo 
            break;
        fi
    done
done
