#!/usr/bin/env bash

set -euo pipefail

source "$BASH_LIB_DIR/core.sh"
source "$BASH_LIB_DIR/system.sh"

help() {
  cat <<-EOT
		Execute command with current TTY as stdin.

		Usage:
		  $(self) [<options>] [<command> [<param>...]]

		Args:
		  <command>   Command to execute.
		  <param>...  Parameters passed to command.

		Options:
		  -h  Print this help.

		When no command is passed, TTY is printed instead.
	EOT
}

main() {
  local opt

  while getopts ":h" opt; do
    case "$opt" in
      h) help; exit ;;
      *) die_invalid_opt "$opt" ;;
    esac
  done

  shift $((OPTIND - 1))

  if [[ -t 0 ]]; then
    if [[ $# -gt 0 ]]; then
      "$@"
    else
      tty
    fi
    return 0
  fi

  local device

  if is_mingw; then
    device=/dev/$(ps -p $$ | tail --lines=+2 | awk '{print $5}') # MinGW ps has very limited options.
  else
    device=/dev/$(ps h -o tty -p $$) # No header, output tty, current PID.
  fi

  if [[ ! -c $device ]]; then
    die "unable to detect TTY"
  fi

  if [[ $# -gt 0 ]]; then
    "$@" < "$device"
  else
    echo "$device"
  fi
}

main "$@"
