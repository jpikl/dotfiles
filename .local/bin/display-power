#!/usr/bin/env bash

# shellcheck source=utils.sh
source "$BASH_DIR/utils.sh"

print_help() {
  echo "Change display power mode."
  echo
  echo "Usage:"
  echo "  $(self) [options] <mode>"
  echo
  echo "Options:"
  echo "  -d, --delay=<seconds>  Change mode after a delay."
  echo "  -h, --help             Display this help."
  echo
  echo "Mode:"
  echo "  on       Turn on display."
  echo "  standby  Stand-by display."
  echo "  suspend  Suspend display."
  echo "  off      Turn off display."
}

set_delay() {
  # shellcheck disable=SC2015
  is_integer "$1" && [[ $1 -ge 0 ]] || die "Invalid delay '$1'!"
  delay=$1
}

set_mode() {
  [[ $1 =~ ^(on|standby|suspend|off)$ ]] || die "Invalid mode '$1'!"
  mode=$1
}

process_args() {
  require_gnu_getopt

  local -r short_opts=d:h
  local -r long_opts=delay:,help
  local args

  args=$(get_args "$short_opts" "$long_opts" "$@") || die_invalid_args
  eval set -- "$args"

  while true ; do
    case "$1" in
      -d|--delay) set_delay "$2"; shift 2 ;;
      -h|--help)    print_help; exit ;;
      --)           shift; break ;;
      *)            die_unprocessable_args ;;
    esac
  done

  if [[ $# -ge 1 ]]; then
    set_mode "$1"
  else
    die_missing_args
  fi
}

display_power() {
  require_cmd xset
  [[ $delay ]] && sleep "$delay"
  xset dpms force "$mode"
}

function main() {
  local delay
  local mode

  process_args "$@"
  display_power
}

main "$@"
