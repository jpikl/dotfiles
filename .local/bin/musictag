#!/usr/bin/env bash

set -euo pipefail
shopt -s extglob

source ~/.local/lib/bash/core.sh
source ~/.local/lib/bash/path.sh

help() {
  cat <<-EOT
		Automatically fill ID3 tags in music directory.

		Usage:
		  $(self) [<options>] [<directory>]

		Args:
		  <directory> Music directory to process.
		              Defaults to the USER_MUSIC_DIR environment variable.

		Options:
		  -v  Verbose mode with additional output.
		  -h  Print this help.

		See 'musiccheck -h' for expected music directory structure.
	EOT
}

main() {
  local verbose=false
  local opt

  while getopts ":vh" opt; do
    case "$opt" in
      v) verbose=true ;;
      h) help; exit ;;
      *) die_invalid_opt "$opt" ;;
    esac
  done

  shift $((OPTIND - 1))
  local music_dir

  if [[ $# -gt 0 ]]; then
    music_dir=$(path_make_absolute "$1")
  else
    music_dir=$(path_from_env USER_MUSIC_DIR)
  fi

  if [[ ! -d $music_dir ]]; then
    die "'$music_dir' is not a directory"
  fi

  local options=()

  if [[ $verbose == true ]]; then
    options+=(-v)
  fi

  echo "Checking structure..."
  echo
  musiccheck "${options[@]}"

  echo "Updating tags..."
  echo
  update_tags
}

update_tags() {
  while IFS= read -r path; do
    if ! is_audio_file "$path"; then
      continue
    fi
    if ! audiotag -c "$path" &>/dev/null; then
      audiotag "${options[@]}" "$path"
    fi
  done < <(list_at_depth 4)
}

list_at_depth() {
  find "$music_dir" -mindepth "$1" -maxdepth "$1"
}

is_audio_file() {
  # Ignore m4a for now because audiotag/id3 cannot work with it
  [[ $1 == *.mp3 || $1 == *.ogg ]]
}

main "$@"
