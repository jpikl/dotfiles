#!/usr/bin/env bash

set -euo pipefail

source "$BASH_LIB_DIR/core.sh"
source "$BASH_LIB_DIR/args.sh"
source "$BASH_LIB_DIR/utils.sh"

help() {
  cat <<-EOT
		Set version of a maven project.

		Usage:
		  $(self) [options] <version>

		Options:
		  -b  Create backup of original pom.xml files.
		  -v  Verbose mode with additional output.
		  -h  Display this help.

		Version:
		  Version to set.
	EOT
}

set_version() {
  is_printable "$1" || die "version is blank"
  version=$1
}

init() {
  local opt

  while getopts ":bvh" opt; do
    case "$opt" in
      b) backup=true ;;
      v) verbose=true ;;
      h) help; exit ;;
      *) die_invalid_opt "$opt" ;;
    esac
  done

  shift $((OPTIND - 1))

  if [[ $# -ge 1 ]]; then
    set_version "$1"
  else
    die_missing_arg
  fi
}

run() {
  [[ -f pom.xml ]] || die "no pom.xml in the current directory"

  local args=()

  if [[ $verbose = false ]]; then
    args+=("--quiet")
  fi

  args+=("versions:set" "-DgenerateBackupPoms=$backup")

  if [[ $version ]]; then
    args+=("-DnewVersion=$version")
  fi

  mvn "${args[@]}"
}

function main() {
  local backup=false
  local verbose=false
  local version

  init "$@"
  run
}

main "$@"
