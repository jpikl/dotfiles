#!/usr/bin/env bash

set -euo pipefail

source "$BASH_LIB_DIR/core.sh"
source "$BASH_LIB_DIR/utils.sh"

help() {
  cat <<-EOT
		Set version of a Maven project.

		Usage:
		  $(self) [options] <version>

		Options:
		  -b  Create backup of original pom.xml files.
		  -v  Verbose mode with additional output.
		  -h  Display this help.

		Version:
		  Version to set.
	EOT
}

main() {
  local backup=false
  local verbose=false
  local opt

  while getopts ":bvh" opt; do
    case "$opt" in
      b) backup=true ;;
      v) verbose=true ;;
      h) help; exit ;;
      *) die_invalid_opt "$opt" ;;
    esac
  done

  shift $((OPTIND - 1))
  [[ $# -eq 0 ]] && die_missing_arg

  is_printable "$1" || die "version is blank"
  local version=$1

  [[ -f pom.xml ]] || die "no pom.xml in the current directory"

  local args=("versions:set" "-DgenerateBackupPoms=$backup")
  [[ $verbose = false ]] && args+=("--quiet")
  [[ $version ]] && args+=("-DnewVersion=$version")

  mvn "${args[@]}"
}

main "$@"
