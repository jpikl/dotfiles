#!/usr/bin/env bash

set -euo pipefail

source "$BASH_LIB_DIR/core.sh"

help() {
  cat <<-EOT
		Print property of a Maven project in each Git branch.

		Usage:
		  $(self) [<options>] <property> <branch>...
		  command | $(self) [<options>] <property>

		Args:
		  <property>   Name of a property.
		  <branch>...  Git branches.

		The property is read from pom.xml in the current working directory.
		When a command is piped to $(self), branches are read as lines from stdin.

		Options:
		  -h  Print this help.
	EOT
}

main() {
  local opt

  while getopts ":h" opt; do
    case "$opt" in
      h) help; exit ;;
      *) die_invalid_opt "$opt" ;;
    esac
  done

  shift $((OPTIND - 1))
  [[ $# -eq 0 ]] && die_missing_arg

  local property=$1
  local -a branches

  shift 1

  if [[ ! -t 0 ]]; then
    mapfile -t branches
  elif [[ $# -gt 0 ]]; then
    branches=("$@")
  else
    die_help "no branch"
  fi

  for branch in "${branches[@]}"; do
    print_table_row "$branch" "$property"
  done | format_table
}

print_table_row() {
  local value
  value=$(print_property_value "$1" "$2") || value="?"
  printf "%s;%s\n" "$value" "$1"
}

print_property_value() {
  git grep --fixed-strings "<$2>" "$1" -- pom.xml \
    | sed --regexp-extended 's/.*>(.*)<\/.*/\1/'
}

format_table() {
  column  --table --separator ";" | sort --version-sort
}

main "$@"
