#!/usr/bin/env bash

set -euo pipefail

readonly SC_EXCLUDE=SC1090 # Can't follow non-constant source.

help() {
  cat <<-EOT
		Do things with Bash files.

		Usage:
		  $(basename "$0") <command>

		Commands:
		  l, list   List bash files.
		  c, check  Validate bash files using shellcheck.

		Links:
		  shellcheck  https://shellcheck.net
	EOT
}

main() {
  case "${1-}" in
    l|list)  list_files ;;
    c|check) check_files ;;
    *)     help ;;
  esac
}

list_files() {
  cd "$HOME"
  list_possible_files | grep --fixed-strings \
                             --line-regexp \
                             --file=<(list_commited_files)
}

list_possible_files() {
  local files=(
    ~/.bash_logout
    ~/.bash_profile
    ~/.bashrc
    ~/.profile
    ~/.local/bin/*
    ~/.local/lib/bash/*.sh
  )
  printf "%s\n" "${files[@]}"
}

list_commited_files() {
  git --git-dir="$HOME/.dotfiles.git" \
      --work-tree="$HOME" \
      ls-files \
      --full-name \
    | sed "s,^,$HOME/,"
}

check_files() {
  local files
  mapfile -t files < <(list_files)
  shellcheck --exclude=$SC_EXCLUDE "${files[@]}"
  echo "All Bash files are valid."
}

main "$@"
