#!/usr/bin/env bash

set -euo pipefail

readonly SC_EXCLUDE=SC1090 # Can't follow non-constant source.

help() {
  cat <<-EOT
		List or validate Bash files from dotfiles repository.

		Usage:
		  $(basename "$0") [command]

		Commands:
		  l, list      List Bash files (default command).
		  d, describe  List Bash scripts and their description.
		  c, check     Validate Bash files using shellcheck.
		  h, help      Print this help.

		Links:
		  shellcheck  https://shellcheck.net
	EOT
}

main() {
  case "${1-list}" in
    l|list)     list_files ;;
    d|describe) describe_files ;;
    m|markdown) describe_files_md ;; # Undocumented
    c|check)    check_files ;;
    *)          help ;;
  esac
}

list_files() {
  local files=(
    ~/.bash_logout
    ~/.bash_profile
    ~/.bashrc
    ~/.profile
    ~/.local/bin/*
    ~/.local/lib/bash/*.sh
  )
  printf "%s\n" "${files[@]}" | filter_git_files
}

list_bin_files() {
  printf "%s\n" ~/.local/bin/* | filter_git_files
}

list_git_files() {
  cd "$HOME"
  git --git-dir="$HOME/.dotfiles.git" \
      --work-tree="$HOME" \
      ls-files \
      --full-name \
    | sed "s,^,$HOME/,"
}

filter_git_files() {
  grep --fixed-strings \
       --line-regexp \
       --file=<(list_git_files)
}

describe_files() {
  local script
  while read -r script; do
    echo "${script##*/}|$(describe_file "$script")"
  done < <(list_bin_files) | column --table --separator='|'
}

describe_files_md() {
  local script
  while read -r script; do
    local name=${script##*/}
    echo "- [$name](../.local/bin/$name) - $(describe_file "$script")"
  done < <(list_bin_files)
}

describe_file() {
  "$1" -h | head --lines=1
}

check_files() {
  local files
  mapfile -t files < <(list_files)
  shellcheck --exclude=$SC_EXCLUDE "${files[@]}"
  echo "All Bash files are valid."
}

main "$@"
