#!/usr/bin/env bash

set -euo pipefail

source "$BASH_LIB_DIR/core.sh"
source "$BASH_LIB_DIR/utils.sh"

help() {
  cat <<-EOT
		Print progress bar.

		Usage:
		  $(self) [options] <value>

		Options:
		  -w <width>  Progress bar width (default: $width).
		  -m <value>  Maximum progress value (default: $max_value).
		  -f <char>   Character used to draw foreground (default: '$fg_char').
		  -b <char>   Character used to draw Background (default: '$bg_char').
		  -h          Display this help.

		Value:
		  Progress value between 0 and maximum value (default: $max_value).
	EOT
}

main() {
  local value
  local max_value=100
  local width=80
  local fg_char="#"
  local bg_char="-"
  local opt

  while getopts ":w:m:f:b:h" opt; do
    case "$opt" in
      w) # shellcheck disable=SC2015
         is_integer "$OPTARG" && [[ $OPTARG -ge 1 ]] || die "invalid width '$OPTARG'"
         width=$OPTARG ;;
      m) # shellcheck disable=SC2015
         is_integer "$OPTARG" && [[ $OPTARG -ge 1 ]] || die "invalid max value '$OPTARG'"
         max_value=$OPTARG ;;
      f) # shellcheck disable=SC2015
         is_character "$OPTARG" || die "invalid foreground character '$OPTARG'"
         fg_char=$OPTARG ;;
      b) is_character "$OPTARG" || die "invalid background character '$OPTARG'"
         bg_char=$OPTARG ;;
      h) help; exit ;;
      *) die_invalid_opt "$opt" ;;
    esac
  done

  shift $((OPTIND - 1))
  [[ $# -eq 0 ]] && die_missing_arg

  # shellcheck disable=SC2015
  is_integer "$1" && [[ $1 -ge 0 ]] || die "Invalid value '$1'"
  local value=$1

  local fg_width=$(( width * value / max_value ))
  local bg_width=$(( width - fg_width ))

  repeat_value "$fg_width" "$fg_char"
  repeat_value "$bg_width" "$bg_char"
}

main "$@"
