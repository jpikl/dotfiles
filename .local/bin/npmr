#!/usr/bin/env bash

set -euo pipefail

source "$BASH_LIB_DIR/core.sh"

help() {
  cat <<-EOT
		Run script of a npm package.

		Usage:
		  $(self) [options] [--] <script>...

		Options:
		  -h  Print this help.

		Script:
		  One or more script names.
		  First script defined in package.json will be run.
	EOT
}

main() {
  local opt

  while getopts ":h" opt; do
    case "$opt" in
      h) help; exit ;;
      *) die_invalid_opt "$opt" ;;
    esac
  done

  shift $((OPTIND - 1))

  [[ $# -eq 0 ]] && die_missing_arg
  [[ -f package.json ]] || die "no package.json in current directory"

  local script
  script=$(get_runnable_script "$@")

  if [[ $script ]]; then
    npm run --silent "$script"
  else
    die "no runnable scripts: $*"
  fi
}

get_runnable_script() {
  printf "%s\n" "$@" \
    | grep --line-regexp --fixed-string --file=<(list_runnable_scripts)  \
    | head --lines=1 \
    || true
}

list_runnable_scripts() {
  # Lines with script names start with 2 spaces which we need to cut off.
  npm run | grep '^  \S' | cut --characters=3-
}

main "$@"
