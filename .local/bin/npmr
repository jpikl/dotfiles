#!/usr/bin/env bash

set -euo pipefail

source ~/.local/lib/bash/core.sh

help() {
  cat <<-EOT
		Choose script(s) of a npm package to run.

		Usage:
		  $(self) [<options>] [<script>...]

		Args:
		  <scipt>... Scripts to run.

		Options:
		  -1  Run only the first available script.
		  -S  Do not silence npm run output.
		  -h  Print this help.

		User is promted to select script if none is provided.
	EOT
}

main() {
  local opt
  local single=false
  local silent=true

  while getopts ":1Sh" opt; do
    case "$opt" in
      1) single=true ;;
      S) silent=false ;;
      h) help; exit ;;
      *) die_invalid_opt "$opt" ;;
    esac
  done

  shift $((OPTIND - 1))

  if [[ ! -f package.json ]]; then
    die "no package.json in current directory"
  fi

  # Lines with script names start with 2 spaces which we need to cut off.
  local scripts
  mapfile -t scripts < <(npm run | grep '^  \S' | cut --characters=3-)

  if [[ $# -eq 0 ]]; then
    if [[ ${#scripts[@]} -eq 0 ]]; then
      die "package.json does not have any scripts to choose from"
    fi

    local selected_script
    selected_script=$(choose -p "Script to run:" "${scripts[@]}")

    if [[ $selected_script ]]; then
      run_script "$selected_script"
    fi

    exit
  fi

  local input_script
  local matched_script

  for input_script; do
    matched_script=

    for script in "${scripts[@]}"; do
      if [[ $script == "$input_script" ]]; then
        matched_script=$script
        break
      fi
    done

    if [[ $matched_script ]]; then
      run_script "$matched_script"

      if [[ $single == true ]]; then
        exit
      fi
    elif [[ $single == false ]]; then
      die "missing script: $input_script"
    fi
  done

  if [[ $single == true ]]; then
    die "no runnable scripts: $*"
  fi
}

run_script() {
  if [[ $silent == true ]]; then
    npm run --silent "$1"
  else
    npm run "$1"
  fi
}

main "$@"
