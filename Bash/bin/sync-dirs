#!/usr/bin/env bash

# shellcheck source=utils.sh
source "$BASH_DIR/utils.sh"

print_help() {
  echo "Synchronize two directories using rsync."
  echo
  echo "Usage:"
  echo "  $(self) [options] [--] <source> <destination>"
  echo
  echo "Options:"
  echo "  -t, --times-only  Preserve only modification times."
  echo "  -e, --exfat       Optimize for exFAT filesystem."
  echo "  -f, --force       Skip dry run. Perform sync without confirmation."
  echo "  -h, --help        Display this help."
  echo
  echo "Source:"
  echo "  Source directory."
  echo
  echo "Destination:"
  echo "  Destination directory."
}

set_source() {
  [[ -d $1 ]] || die "'$1' is not a directory."

  if [[ $1 == */ ]]; then
    source=$1
  else
    source=$1/ # Source directory MUST end with /.
  fi
}

set_destination() {
  [[ -d $1 ]] || die "'$1' is not a directory."
  destination=$1
}

process_args() {
  require_gnu_getopt

  local -r short_opts=tefh
  local -r long_opts=times-only,exfat,force,help
  local args

  args=$(get_args "$short_opts" "$long_opts" "$@") || die_invalid_args
  eval set -- "$args"

  while true ; do
    case "$1" in
      -t|--times-only) times_only=true; shift ;;
      -e|--exfat)      exfat=true; shift ;;
      -f|--force)      force=true; shift ;;
      -h|--help)       print_help; exit ;;
      --)              shift; break ;;
      *)               die_unprocessable_args ;;
    esac
  done

  if [[ $# -ge 2 ]]; then
    set_source "$1"
    set_destination "$2"
  else
    die_missing_args
  fi
}

sync_dirs() {
  require_cmd rsync

  if [[ $source -ef $destination ]]; then
    die "'$source' and '$destination' point to the same directory!"
  fi

  local opts=("--delete" "--human-readable")

  if [[ $times_only = true ]]; then
      opts+=("--recursive" "--times")
  else
      opts+=("--archive")
  fi

  if [[ $exfat == true ]]; then
      opts+=("--modify-window=1" "--exclude='System Volume Information'")
  fi

  local -r opts_info=("--itemize-changes" "--stats")
  local -r opts_progress=("--info=progress2")

  if [[ $force = true ]]; then
    echo "Synchronizing '$source' to '$destination'"
    rsync "${opts[@]}" "${opts_info[@]}" "${opts_progress[@]}" -- "$source" "$destination"
  else
    echo "Detecting differences from '$source' to '$destination'"
    rsync "${opts[@]}" "${opts_info[@]}" --dry-run -- "$source" "$destination"
    echo

    if confirm "Continue with synchronization?"; then
        echo "Synchronizing '$source' to '$destination'"
        rsync "${opts[@]}" "${opts_progress[@]}" -- "$source" "$destination"
    fi
  fi
}

function main() {
  local times_only=false
  local exfat=false
  local force=false
  local source
  local destination

  process_args "$@"
  sync_dirs
}

main "$@"
