#!/usr/bin/env bash

# shellcheck source=utils.sh
source "$BASH_DIR/utils.sh"

print_help() {
  local -r self=$(basename "$0")

  echo "Set version of a maven project."
  echo
  echo "Usage:"
  echo "  $self [options] [version]"
  echo
  echo "Options:"
  echo "  -b, --backup  Create backup of original pom.xml files."
  echo "  -h, --help    Display this help."
  echo
  echo "Version:"
  echo "  New version to set."
  echo "  User will be prompted to enter a version if omitted."
}

process_args() {
  require_gnu_getopt

  local -r short_opts=bh
  local -r long_opts=backup,help
  local args

  args=$(get_args "$short_opts" "$long_opts" "$@") || die
  eval set -- "$args"

  while true ; do
    case "$1" in
      -b|--backup) backup=true; shift ;;
      -h|--help)   print_help; exit ;;
      --)          shift; break ;;
      *)           die "Unable to process arguments!" ;;
    esac
  done

  version=$1
}

mvn_set_version() {
  local args=("-DgenerateBackupPoms=$backup")

  if [[ $version ]]; then
    args+=("-DnewVersion=$version")
  fi

  mvn versions:set "${args[@]}"
}

function main() {
  local backup=false
  local version

  process_args "$@"
  mvn_set_version
}

main "$@"
