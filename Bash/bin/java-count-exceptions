#!/usr/bin/env bash

# shellcheck source=utils.sh
source "$BASH_DIR/utils.sh"

print_help() {
  echo "Count occurrences of Java exceptions in a log file."
  echo
  echo "Usage:"
  echo "  $(self) [options] [--] [file]"
  echo
  echo "Options:"
  echo "  -m, --messages  Include exception messages."
  echo "  -h, --help      Display this help."
  echo
  echo "File:"
  echo "  Log file to read."
  echo "  If not specified, text is read from stdin."
}

set_file() {
  [[ -f "$1" ]] || die "'$1' is not a file!"
  file=$1
}

process_args() {
  require_gnu_getopt

  local -r short_opts=mh
  local -r long_opts=messages,help
  local args

  args=$(get_args "$short_opts" "$long_opts" "$@") || die_invalid_args
  eval set -- "$args"

  while true ; do
    case "$1" in
      -m|--messages) messages=true; shift ;;
      -h|--help)     print_help; exit ;;
      --)            shift; break ;;
      *)             die_unprocessable_args ;;
    esac
  done

  if [[ $# -ge 1 ]]; then
    set_file "$1"
  fi
}

java_count_exceptions() {
  if [[ $file ]]; then
    exec <"$file"
  fi

  local pattern='^((\w|\$)+\.)*(\w|\$)+(Exception|Throwable|Error)'

  if [[ $messages = true ]]; then
    pattern="${pattern}.*"
  fi

  grep --extended-regexp --only-matching "$pattern" \
    | LC_ALL=C sort \
    | LC_ALL=C uniq --count  \
    | LC_ALL=C sort --reverse
}

function main() {
  local messages=false
  local file

  process_args "$@"
  java_count_exceptions
}

main "$@"
