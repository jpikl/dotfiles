#!/usr/bin/env bash

# shellcheck source=utils.sh
source "$BASH_DIR/utils.sh"

print_help() {
  echo "Get version of a maven project."
  echo
  echo "Usage:"
  echo "  $(self) [options] [--] [file]"
  echo
  echo "Options:"
  echo "  -h, --help  Display this help."
  echo
  echo "File:"
  echo "  Path to a pom.xml file to read the version from."
  echo "  If not specified, pom.xml is read from stdin."
}

set_file() {
  [[ -f $1 ]] || die "'$1' is not a file!"
  file=$1
}

process_args() {
  require_gnu_getopt

  local -r short_opts=h
  local -r long_opts=help
  local args

  args=$(get_args "$short_opts" "$long_opts" "$@") || die_invalid_args
  eval set -- "$args"

  while true ; do
    case "$1" in
      -h|--help) print_help; exit ;;
      --)        shift; break ;;
      *)         die_unprocessable_args ;;
    esac
  done

  if [[ $# -ge 1 ]]; then
    set_file "$1"
  fi
}

mvn_get_version() {
  require_cmd xmllint

  if [[ $file ]]; then
    exec <"$file"
  fi

  local -r xpath='/*[local-name()="project"]/*[local-name()="version"]/text()'
  xmllint --xpath "$xpath" <(cat)
}

function main() {
  local file

  process_args "$@"
  mvn_get_version
}

main "$@"
